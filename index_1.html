<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Random Chord Progression Generator</title>
<style>
  :root{--card:#17a2b8;--bg:#f0f2f5;--panel:#fff}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); margin:0; padding:20px; display:flex; justify-content:center;}
  .container{width:95%;max-width:960px;background:var(--panel);padding:22px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  h1{color:#007bff;margin:0 0 14px;text-align:center}
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-bottom:12px}
  label{font-weight:600;margin-bottom:6px;display:block}
  .control-item{display:flex;align-items:center;gap:10px}
  select,input[type="number"]{padding:10px;border-radius:6px;border:1px solid #ccd0d5;box-sizing:border-box}
  #num-chords{max-width:80px}
  .options-group{display:flex;flex-direction:column;gap:8px}
  .option-item{display:flex;justify-content:space-between;align-items:center}
  .randomize-toggle{display:flex;align-items:center;gap:8px;font-size:.92rem}
  .button-group{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  button.action-btn{flex:1;padding:11px;border-radius:6px;border:0;font-weight:700;cursor:pointer}
  #generate-btn{background:#007bff;color:#fff}#surprise-btn{background:#28a745;color:#fff}
  .progression-display{margin-top:12px;padding:18px;background:#f8f9fa;border-radius:8px;border:1px solid #e6e9ec;min-height:120px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}
  .chord-card{background:var(--card);color:#fff;padding:12px 18px;border-radius:8px;min-width:88px;text-align:center;opacity:0;transform:scale(.9);transition:all .26s ease;cursor:default}
  .chord-card.visible{opacity:1;transform:scale(1)}
  .chord-name{font-weight:700;font-size:1.05rem}
  .chord-degree{margin-top:6px;font-size:.9rem;opacity:.95}
  .params-display{margin-top:10px;text-align:center;color:#333;min-height:1.2em}
  @media (max-width:600px){ .controls{grid-template-columns:1fr} .chord-card{min-width:68px;padding:8px} }
</style>
</head>
<body>
  <div class="container">
    <h1>Random Chord Progression Generator</h1>

    <div class="controls">
      <div>
        <label for="key-select">Key</label>
        <div class="control-item">
          <select id="key-select">
            <option value="C">C Major</option>
            <option value="G">G Major</option>
            <option value="D">D Major</option>
            <option value="A">A Major</option>
            <option value="E">E Major</option>
            <option value="B">B Major</option>
            <option value="F# / Gb">F# / Gb Major</option>
            <option value="C# / Db">C# / Db Major</option>
            <option value="F">F Major</option>
            <option value="Bb / A#">Bb / A# Major</option>
            <option value="Eb / D#">Eb / D# Major</option>
            <option value="Ab / G#">Ab / G# Major</option>
          </select>
          <div class="randomize-toggle">
            <input type="checkbox" id="randomize-key-chk" checked />
            <label for="randomize-key-chk" style="margin:0;font-weight:500">Randomize</label>
          </div>
        </div>
      </div>

      <div>
        <label for="num-chords">Number of Chords (2-16)</label>
        <input id="num-chords" type="number" value="4" min="2" max="16" />
      </div>

      <div>
        <label>Chord Options</label>
        <div class="options-group">
          <div class="option-item">
            <label><input id="include-7ths" type="checkbox" /> Include 7ths</label>
            <div class="randomize-toggle"><input id="randomize-7ths-chk" type="checkbox" checked /><label for="randomize-7ths-chk">Randomize</label></div>
          </div>

          <div class="option-item">
            <label><input id="include-slash-chords" type="checkbox" /> Slash Chords</label>
            <div class="randomize-toggle"><input id="randomize-slash-chk" type="checkbox" checked /><label for="randomize-slash-chk">Randomize</label></div>
          </div>

          <div class="option-item">
            <label><input id="allow-augmented" type="checkbox" /> Augmented (V+)</label>
            <div class="randomize-toggle"><input id="randomize-aug-chk" type="checkbox" checked /><label for="randomize-aug-chk">Randomize</label></div>
          </div>

          <div class="option-item">
            <label><input id="common-progressions" type="checkbox" /> Common Chord Progressions</label>
          </div>

          <div class="option-item">
            <label for="common-prog-select">Choose Progression</label>
            <select id="common-prog-select" disabled>
              <option value="canon">Canon-like</option>
              <option value="chpop1">Chinese Pop 1</option>
              <option value="chpop2">Chinese Pop 2</option>
              <option value="creep">Creep</option>
              <option value="overused">Over-used</option>
              <option value="36251">3 6 2 5 1</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button id="generate-btn" class="action-btn">Generate</button>
      <button id="surprise-btn" class="action-btn">Surprise Me!</button>
    </div>

    <div id="generation-params-display" class="params-display"></div>
    <div id="progression-display" class="progression-display"><p style="color:#666;margin:0">Your chords will appear here!</p></div>
  </div>

<script>
/* ---------- Data & theory ---------- */
const majorIntervals = [0,2,4,5,7,9,11];
const SHARPS = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLATS  = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

const commonProgressions = {
  canon: ["I","V","vi","iii","IV","I","IV","V"],
  chpop1: ["I","V","vi","I","IV","I","ii","V"],
  chpop2: ["IV","V","iii","vi","ii","V","I"],
  creep: ["I","III","IV","iv"],
  overused: ["I","vi","IV","V"],
  "36251": ["iii","vi","ii","V","I"]
};
const progressionNames = {
  canon:"Canon-like", chpop1:"Chinese Pop 1", chpop2:"Chinese Pop 2",
  creep:"Creep", overused:"Over-used", "36251":"3 6 2 5 1"
};

function preferFlats(keyLabel){
  return keyLabel.includes('b') || keyLabel.includes('Bb') || keyLabel.includes('Eb') || keyLabel.includes('Ab');
}
function rootToken(keyLabel){ return keyLabel.split(' ')[0]; }
function getScaleNotes(keyLabel){
  const root = rootToken(keyLabel);
  const useFlat = preferFlats(keyLabel);
  const ns = useFlat ? FLATS : SHARPS;
  let idx = ns.indexOf(root);
  if(idx === -1) idx = (useFlat ? SHARPS : FLATS).indexOf(root);
  if(idx === -1) idx = 0;
  return majorIntervals.map(i => (useFlat ? FLATS : SHARPS)[(idx + i) % 12]);
}
function getDiatonicChords(keyLabel){
  const s = getScaleNotes(keyLabel);
  return [
    { degree:'I', root:s[0], type:'maj' },
    { degree:'ii', root:s[1], type:'min' },
    { degree:'iii', root:s[2], type:'min' },
    { degree:'IV', root:s[3], type:'maj' },
    { degree:'V', root:s[4], type:'maj' },
    { degree:'vi', root:s[5], type:'min' },
    { degree:'vii', root:s[6], type:'dim' }
  ];
}
function getChordTones(root, quality){
  const useFlat = FLATS.includes(root);
  const ns = useFlat ? FLATS : SHARPS;
  let idx = ns.indexOf(root);
  if(idx === -1) idx = SHARPS.indexOf(root);
  const n = i => (useFlat ? FLATS : SHARPS)[(idx + i) % 12];
  switch(quality){
    case 'maj': return [n(0), n(4), n(7)];
    case 'min': return [n(0), n(3), n(7)];
    case 'dim': return [n(0), n(3), n(6)];
    case 'aug': return [n(0), n(4), n(8)];
    case 'maj7': return [n(0), n(4), n(7), n(11)];
    case 'min7': return [n(0), n(3), n(7), n(10)];
    case 'dom7': return [n(0), n(4), n(7), n(10)];
    case 'm7b5': return [n(0), n(3), n(6), n(10)];
    default: return [n(0), n(4), n(7)];
  }
}

/* ---------- Utilities ---------- */
const ROMAN_TO_INDEX = { 'I':0,'II':1,'III':2,'IV':3,'V':4,'VI':5,'VII':6 };

function romanPartFromToken(tok){
  // extract continuous roman letters (I/V characters), e.g. "III" or "iv"
  const m = tok.match(/[ivIV]+/);
  return m ? m[0] : null;
}

/* ---------- Option application ---------- */
function chooseSlashBass(root, type){
  const tones = getChordTones(root, type);
  if(!tones || tones.length < 3) return null;
  const candidates = [tones[1], tones[2]].filter(t => t && t !== root);
  if(!candidates.length) return null;
  return candidates[Math.floor(Math.random()*candidates.length)];
}

function applyOptionsToChord(ch, include7, includeSlash, includeAug, rand7, randSlash, randAug, totalChords){
  const c = {...ch}; // copy
  // 7ths
  if(include7){
    const should7 = !rand7 ? true : (Math.random() < 0.5);
    if(should7){
      if(c.degree === 'V') c.type = 'dom7';
      else if(c.type === 'maj') c.type = 'maj7';
      else if(c.type === 'min') c.type = 'min7';
      else if(c.type === 'dim') c.type = 'm7b5';
    }
  }
  // augmented V+
  if(includeAug){
    const doAug = !randAug ? true : (Math.random() < 0.28);
    if(doAug && c.degree === 'V') c.type = 'aug';
  }
  // slash chords with length-based probability
  if(includeSlash){
    const baseProb = totalChords <= 4 ? 0.20 : totalChords <= 8 ? 0.35 : 0.50;
    const doSlash = !randSlash ? (Math.random() < 0.6) : (Math.random() < baseProb);
    if(doSlash){
      const bass = chooseSlashBass(c.root, c.type);
      if(bass) c.bass = bass;
    }
  }
  return c;
}

/* ---------- Progression generation ---------- */
let currentProgression = [];

function generateRandomProgression(keyLabel, n, include7, includeSlash, includeAug, rand7, randSlash, randAug){
  const diatonic = getDiatonicChords(keyLabel);
  const prog = [];
  // start optionally on tonic (keeps musically sensible)
  prog.push({...diatonic[0]});
  for(let i=1;i<n;i++){
    prog.push({...diatonic[Math.floor(Math.random()*diatonic.length)]});
  }
  currentProgression = prog.map(ch => {
    const after = applyOptionsToChord(ch, include7, includeSlash, includeAug, rand7, randSlash, randAug, n);
    after.tones = getChordTones(after.root, after.type);
    return after;
  });
}

function generateCommonProgression(keyLabel, choice, include7, includeSlash, includeAug, rand7, randSlash, randAug){
  const diatonic = getDiatonicChords(keyLabel);
  let tokens = (commonProgressions[choice] || []).slice();

  // shuffle 'overused'
  if(choice === 'overused'){
    for(let i=tokens.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [tokens[i], tokens[j]] = [tokens[j], tokens[i]];
    }
  }

  const mapped = tokens.map(tok => {
    const romanPart = romanPartFromToken(tok);
    if(!romanPart) return null;
    const idx = ROMAN_TO_INDEX[romanPart.toUpperCase()];
    let found = (typeof idx === 'number' && idx >= 0) ? JSON.parse(JSON.stringify(diatonic[idx])) : null;
    // fallback: try matching by degree string (some tokens might include accidental letters)
    if(!found){
      found = diatonic.find(d => d.degree.toUpperCase() === romanPart.toUpperCase()) ? JSON.parse(JSON.stringify(diatonic.find(d => d.degree.toUpperCase() === romanPart.toUpperCase()))) : null;
    }
    if(!found) return null;

    // preserve token casing for display (so 'iv' stays 'iv' and 'III' stays 'III')
    found.token = tok;

    // special Creep overrides (user request): III is major, iv is minor
    if(choice === 'creep'){
      if(tok === 'III') found.type = 'maj';
      if(tok === 'iv') found.type = 'min';
    }
    return found;
  }).filter(Boolean);

  // apply options with totalChords = mapped.length (so slash probability scaled by progression length)
  currentProgression = mapped.map(ch => {
    const after = applyOptionsToChord(ch, include7, includeSlash, includeAug, rand7, randSlash, randAug, mapped.length);
    after.tones = getChordTones(after.root, after.type);
    return after;
  });
}

/* ---------- Rendering ---------- */
function prettyDegree(ch){
  // show token if provided to preserve case (iv vs IV)
  if(ch.token) return ch.token;
  // otherwise fallback to degree
  return ch.degree;
}

function renderProgression(){
  const display = document.getElementById('progression-display');
  const params  = document.getElementById('generation-params-display');
  display.innerHTML = '';
  if(!currentProgression || currentProgression.length === 0){
    display.innerHTML = '<p style="color:#666;margin:0">No progression generated.</p>';
    params.textContent = '';
    return;
  }

  currentProgression.forEach((ch, i) => {
    const card = document.createElement('div');
    card.className = 'chord-card';
    const name = document.createElement('div'); name.className = 'chord-name';
    const deg  = document.createElement('div'); deg.className = 'chord-degree';

    let label = ch.root;
    if(ch.type === 'min') label += 'm';
    else if(ch.type === 'dim') label += 'dim';
    else if(ch.type === 'aug') label += '+';
    else if(ch.type === 'maj7') label += 'Maj7';
    else if(ch.type === 'min7') label += 'm7';
    else if(ch.type === 'dom7') label += '7';
    else if(ch.type === 'm7b5') label += 'm7♭5';
    if(ch.bass) label += '/' + ch.bass;

    name.textContent = label;
    deg.textContent = prettyDegree(ch);

    card.appendChild(name);
    card.appendChild(deg);

    display.appendChild(card);
    setTimeout(()=>card.classList.add('visible'), i * 70);
  });

  const keyLabel = document.getElementById('key-select').value;
  let info = '';
  if(document.getElementById('common-progressions').checked){
    const chosen = document.getElementById('common-prog-select').value;
    const seq = currentProgression.map(c => prettyDegree(c)).join(' ');
    info = `${progressionNames[chosen]} (${seq})`;
  } else {
    const seq = currentProgression.map(c => c.degree).join(' ');
    info = `Random: ${seq}`;
  }
  const opts = [];
  if(document.getElementById('include-7ths').checked) opts.push('7ths');
  if(document.getElementById('include-slash-chords').checked) opts.push('slash');
  if(document.getElementById('allow-augmented').checked) opts.push('aug(V+)');

  params.innerHTML = `Key: <strong>${keyLabel}</strong> • ${info}${opts.length ? ' • ' + opts.join(', ') : ''}`;
}

/* ---------- UI wiring ---------- */
const UI = {
  keySel: document.getElementById('key-select'),
  randKeyChk: document.getElementById('randomize-key-chk'),
  numInput: document.getElementById('num-chords'),
  include7: document.getElementById('include-7ths'),
  rand7: document.getElementById('randomize-7ths-chk'),
  includeSlash: document.getElementById('include-slash-chords'),
  randSlash: document.getElementById('randomize-slash-chk'),
  includeAug: document.getElementById('allow-augmented'),
  randAug: document.getElementById('randomize-aug-chk'),
  commonChk: document.getElementById('common-progressions'),
  commonSel: document.getElementById('common-prog-select'),
  genBtn: document.getElementById('generate-btn'),
  surpriseBtn: document.getElementById('surprise-btn')
};
UI.commonChk.addEventListener('change', ()=> UI.commonSel.disabled = !UI.commonChk.checked);

function pickRandomKey(){
  const opts = Array.from(UI.keySel.options).map(o => o.value);
  return opts[Math.floor(Math.random()*opts.length)];
}

/* ---------- Button actions ---------- */
UI.genBtn.addEventListener('click', () => {
  const key = UI.randKeyChk.checked ? pickRandomKey() : UI.keySel.value;
  UI.keySel.value = key;

  // number of chords is always respected in RANDOM mode
  const n = Math.max(2, Math.min(16, parseInt(UI.numInput.value) || 4));

  const inc7 = UI.include7.checked;
  const incSlash = UI.includeSlash.checked;
  const incAug = UI.includeAug.checked;

  const r7 = UI.rand7.checked;
  const rSlash = UI.randSlash.checked;
  const rAug = UI.randAug.checked;

  if(UI.commonChk.checked){
    // common progression - use its defined length
    const sel = UI.commonSel.value || 'canon';
    generateCommonProgression(key, sel, inc7, incSlash, incAug, r7, rSlash, rAug);
  } else {
    generateRandomProgression(key, n, inc7, incSlash, incAug, r7, rSlash, rAug);
  }
  renderProgression();
});

UI.surpriseBtn.addEventListener('click', () => {
  const key = UI.randKeyChk.checked ? pickRandomKey() : UI.keySel.value;
  UI.keySel.value = key;

  // number of chords should come from the input (Surprise Me respects the Number of Chords)
  const n = Math.max(2, Math.min(16, parseInt(UI.numInput.value) || 4));

  // If common progression is OFF we'll randomize the options slightly when their Randomize toggles are checked.
  let inc7 = UI.include7.checked, incSlash = UI.includeSlash.checked, incAug = UI.includeAug.checked;
  const r7 = UI.rand7.checked, rSlash = UI.randSlash.checked, rAug = UI.randAug.checked;

  if(!UI.commonChk.checked){
    inc7 = r7 ? (Math.random() < 0.6) : inc7;
    incSlash = rSlash ? (Math.random() < 0.45) : incSlash;
    incAug = rAug ? (Math.random() < 0.28) : incAug;
    // reflect chosen options in UI so user sees what Surprise Me decided
    UI.include7.checked = inc7;
    UI.includeSlash.checked = incSlash;
    UI.includeAug.checked = incAug;
  }

  if(UI.commonChk.checked){
    // pick a random common progression if Surprise Me (but still use that progression's length)
    const keys = Array.from(UI.commonSel.options).map(o=>o.value);
    UI.commonSel.value = keys[Math.floor(Math.random()*keys.length)];
    generateCommonProgression(key, UI.commonSel.value, UI.include7.checked, UI.includeSlash.checked, UI.includeAug.checked, r7, rSlash, rAug);
  } else {
    generateRandomProgression(key, n, inc7, incSlash, incAug, r7, rSlash, rAug);
  }
  renderProgression();
});

/* ---------- initial render ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // initial random progression
  const k = UI.keySel.value;
  const n = Math.max(2, Math.min(16, parseInt(UI.numInput.value) || 4));
  generateRandomProgression(k, n, UI.include7.checked, UI.includeSlash.checked, UI.includeAug.checked, UI.rand7.checked, UI.randSlash.checked, UI.randAug.checked);
  renderProgression();
});
</script>
</body>
</html>
